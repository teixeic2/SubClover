---
title: "ReAnalysis Table"
author: "CT"
date: "Thursday, December  05, 2016"
output: html_document
note: Re analysis : include Pp analysis using selected datasets from Reanalysis4 (df_REa6)
---

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library (segmented)

```
 


```{r   loadFile}
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\ReAnalysis")
getwd()


#get dataframe created in ReAnalysis4
df_1 <- read.table("df_Rea6.txt",header=TRUE)


#head(df_Data)

#summary(df_Rea6)

# Here used just to save unique values of indexes 

# xx <- unique(df_Rea6$indexLocCult)
# 
# write.csv(xx, "listOfExpCultUsedForPp.csv")

df_Gr <- read.table("CultivarGroup.txt",header=TRUE)

#now merge the two df 

df_Rea6 <- merge(df_1, df_Gr,by=c("indexLocCult"))

summary (df_Rea6)

```
Select two groups of cultivars : hight Pp sensitive response varies and low sensitive cultivar group (TT decreases at the end )

```{r, warning=FALSE}
#Check data filtering indexLocCult. See r2 generated below. 
df_Rea6 %>%
  #filter(indexLocCult=="Launceston1987_Meteora")%>%
  ggplot(aes(x=month(SowingDate), y= Value, colour=SensGroup)) +
  geom_point(shape=21) +
 #geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~., scales = "free")
```


```{r}

#Check data filtering indexLocCult. See r2 generated below. 
df_Rea6 %>%
  filter(Variable=="TTFloAdj")%>%
  ggplot(aes(x=Pp, y= Value, colour=SensGroup)) +
  geom_point(shape=21) +
 #geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~., scales = "free")


```






```{r, warning=FALSE}

#Check cvs 
df_Rea6 %>%
dplyr::filter(Treatcultivar=="Nungarin"|
         Treatcultivar=="SeatonPark"|
           Treatcultivar=="Trikkala"|
           Treatcultivar=="Dalkeith")%>%
  ggplot(aes(x=Pp, y= Value, colour=indexLocCult)) +
  geom_point(shape=21) +
 geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~SensGroup, scales = "free")



```



```{r}
#attempt to get Pp target via TT target 




df_test <- df_Rea6 %>%
  mutate(TTtarg=TTSumSow + 200)

df_test_select <- df_test %>%
select(LocationYear, TTtarg, indexLocCult) %>%
  mutate(SumTTday=TTtarg)
  
head(df_test_select)


df_merged <- merge(df_test_select, df_weather, by=approx("SumTTday"))

#,by.x=c("LocationYear","TTtarg"), by.y=c("LocationYear","SumTTday"))
  

head(df_merged )
```







Create function for retrieving photoperiod as a function of TT after sowing


```{r}



df_weather <- read.table("df_CumTT.txt",header=TRUE)

df_weather <-df_weather %>%
  select(LocationYear,Date, Pp, SumTTday)

summary(df_weather)

#retrieve sowing date per experiment

summary(df_Rea6)


df_temp <-df_Rea6 %>%
  select(LocationYear,indexLocCult, SowingDate,TTSumSow,Variable,Value)

summary(df_temp)

 #find the photoperiod at TT_Target 
  # created a function to find the Pp

#idx_loc <-"Katanning1990"

Pp_finder_func <-function(idx_loc,tt_sow,tt_extra){
  
  #isolate the experiment and cultivar 
  
  df_temp_wea <-df_weather %>%
    filter(LocationYear==idx_loc)
  
  
  
  tt_target <- tt_sow + tt_extra
  
  tryCatch(  
  Pp_target <- approx(df_temp_wea$SumTTday, 
  df_temp_wea$Pp, xout = tt_target, rule = 1)$y,
  error = function(e) 
  {
  Pp_target <- NA
  }
)
 
  return(Pp_target)
  
}
  

TT_extra <- 200
#TTsum estimated to reach 1st trifoliate

Pp_finder_func("Katanning1990",1972.8526,TT_extra)
  
  y_ref <- df_sub$TT_target # y value where we want to find x by interpolation
  
  

 


```



Create the loop to identify each combination of indexLocCult - isolate and calculate stats for each Pp target. 

```{r}
#created loop



indexValues <- unique(df_Rea6$SensGroup)

for(i in 1:length(indexValues)){
  
  print(i)
 
  s <- indexValues [i]
  
  print(s) 

  
  df_sub <- df_Rea6 %>%
    dplyr::filter(SensGroup == s) %>%
    filter(Variable=="TTFloAdj")%>%
  mutate(TT_target=TTSumSow+TT_extra) #define thermal time after sowing for which photoperiod needs to be retrieved 
  
  
 

  
    print(unique(df_sub$indexLocCult))
    
    
    x <- df_sub$Pp
    y <- df_sub$Value
  
  #print(data.frame(x=x,y=y))
  
  fit <- NULL
  fit <- lm(y ~ x)
  
  intercept <- round(fit$coefficients[[1]],2)
  slope <- round(fit$coefficients[[2]],3)
  r2 <- round(summary(fit)$r.squared * 100,2)
  
  print(paste0("int:",intercept," slope:",slope, " r2:",r2))
  
  out.lm <-lm(Value~Pp,data=df_sub)
  
  o<-segmented(out.lm,seg.Z=~Pp,psi=list(Pp=c(12)),
                   control=seg.control(display=FALSE))
      # show stats
      print(summary(o))
  
}



```

Now get slopes and R squares  

```{r}


df_sub <- subset(df_soft_plot, (df_soft_plot$Plot==plots[p] & Depth == depth[d]))
  
  x <- df_sub$Round
  y <- 1-df_sub$PercSoftCum
  
  print(data.frame(x=x,y=y))
  
  
  fit <- NULL
  fit <- lm(y ~ x)
  
  intercept <- round(fit$coefficients[[1]],2)
  slope <- round(fit$coefficients[[2]],3)
  r2 <- round(summary(fit)$r.squared * 100,2)
  # summary(fit)$adj.r.squared
  block <- df_sub$Block[1]
  cv <- as.character(df_sub$Cultivar[1])
  sow <- as.character(df_sub$SowTreat[1])
  sd <- dmy(df_sub$SowingD[1])
  
  
  buf <- c(sow,cv,block, plots[p],  depth[d], intercept, slope, r2, nrow(df_sub))
  print(buf)
  
    if (p==1 & d==1) { 
    all.data <- data.frame(
    Sow = sow,
    Cv = cv,
    Block = block, 
    Plot = plots[p],  
    Depth = depth[d], 
    Int = intercept, 
    Slope = slope, 
    R2 = r2,
    n = nrow(df_sub)
    ) } else {
    all.data <- rbind(all.data, buf) # FIXME: Logic is not working for df creation
  }

# Error:  
#   Warning message:
# In `[<-.factor`(`*tmp*`, ri, value = "2") :
#   invalid factor level, NA generated
  

  }
  
}

summary(all.data)

```



