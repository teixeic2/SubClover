---
title: "ReAnalysis Table"
author: "CT"
date: "Thursday, December  05, 2016"
output: html_document
note: Re analysis : include Pp analysis using selected datasets from Reanalysis4 (df_REa6)
---

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library (segmented)

```
 


```{r   loadFile}
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\ReAnalysis")

getwd()

#get dataframe created in ReAnalysis4
df_1 <- read.table("df_Rea6.txt",header=TRUE)

#head(df_Data)

#summary(df_Rea6)

# Here used just to save unique values of indexes 

# xx <- unique(df_Rea6$indexLocCult)
# 
# write.csv(xx, "listOfExpCultUsedForPp.csv")

df_Gr <- read.table("CultivarGroup.txt",header=TRUE)

#now merge the two df 

df_Rea6 <- merge(df_1, df_Gr,by=c("indexLocCult"))

summary (df_Rea6)

```
Select two groups of cultivars : hight Pp sensitive response varies and low sensitive cultivar group (TT decreases at the end )

```{r, warning=FALSE}
#Check data filtering indexLocCult. See r2 generated below. 
df_Rea6 %>%
  #filter(indexLocCult=="Launceston1987_Meteora")%>%
  ggplot(aes(x=month(SowingDate), y= Value, colour=SensGroup)) +
  geom_point(shape=21) +
 #geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~., scales = "free")
```


```{r}

#Check data filtering indexLocCult. See r2 generated below. 
df_Rea6 %>%
  filter(Variable=="TTFloAdj")%>%
  ggplot(aes(x=Pp, y= Value, colour=SensGroup)) +
  geom_point(shape=21) +
 #geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~., scales = "free")


```






```{r, warning=FALSE}

#Check cvs 
df_Rea6 %>%
dplyr::filter(Treatcultivar=="Nungarin"|
         Treatcultivar=="SeatonPark"|
           Treatcultivar=="Trikkala"|
           Treatcultivar=="Dalkeith")%>%
  ggplot(aes(x=Pp, y= Value, colour=indexLocCult)) +
  geom_point(shape=21) +
 geom_smooth(se=FALSE)+
  #theme(legend.position="none")+
  facet_grid(Variable~SensGroup, scales = "free")



```




Create function for retrieving photoperiod as a function of TT after sowing


```{r}

df_weather <- read.table("df_CumTT.txt",header=TRUE)

df_weather <-df_weather %>%
  select(LocationYear,Date, Pp, SumTTday)

summary(df_weather)

```

```{r}
Pp_finder_func <- function(idx_loc,tt_target){
  
  #isolate the experiment and cultivar 
  df_temp_wea <- df_weather %>%
    filter(LocationYear == idx_loc)
  
 # tt_target <- tt_sow + tt_extra
  
  # lookup for Pp at new tt sum
  tryCatch(  
  Pp_target <- approx(df_temp_wea$SumTTday, 
  df_temp_wea$Pp, xout = tt_target, rule = 1)$y,
  error = function(e) 
  {
  Pp_target <- NA
  }
)
 
  return(Pp_target)
  
}
```

```{r}
tt_target <- 2172.8526
#TTsum estimated to reach 1st trifoliate 

#test if function is working : example : 
Pp_finder_func("Katanning1990",tt_target)
```

Create the loop to identify each combination of indexLocCult - isolate and calculate stats for each Pp target. 

```{r}
#created loop

indexValues <- unique(df_Rea6$SensGroup)
 Vc_all <- vector()
for(i in 1:length(indexValues)){
  
  print(i)
 
  s <- indexValues [i]
  
  print(s) 
  
  df_s <- df_Rea6 %>%
    dplyr::filter(SensGroup == s) %>%
    filter(Variable=="TTFloAdj") %>%
    mutate(TT_target=TTSumSow+TT_extra) %>% #define thermal time after sowing for which photoperiod needs to be retrieved 
    rowwise() %>%
    mutate(Pp_target=Pp_finder_func(as.character(LocationYear),TT_target)) # functions gets a charater therefore format change
     
    print(unique(df_s$indexLocCult))
    
    x <- df_s$Pp_target
    y <- df_s$Value
  
  
  out.lm <-lm(Value~Pp,data=df_s)
  
  o<-segmented(out.lm,seg.Z=~Pp,psi=list(Pp=c(12)),
                   control=seg.control(display=FALSE))
      
  
  # find stats
      s <- slope(o)$Pp[,1]    
      interc <- intercept(o)
      
      r2 <- summary.segmented(o)$adj.r.squared
      slope1 <- round(s[1], digits = 4)
      slope2 <- round(s[2], digits = 4)
      pVs1 <- summary.segmented(o)$coefficients[14]#pvalue slope1
      pVs2 <-summary.segmented(o)$coefficients[15]#pvalue slope2
      
      # find breaks
      b = o$psi[,2]
      
      Vc_temp <- c(r2,slope1,slope2,pVs1,pVs2,b)
      Vc_all <- rbind(Vc_all,Vc_temp)
      # show slopes and breakpoints
      print(paste0(" slope: ",s, " break: ", b))
      
     # print(summary(o))
  
}


# loop acros multiple TT extras
# select best stats or simply store all (better I think) and test in next chunck

```

