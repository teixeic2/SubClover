---
title: "Hardseeds breakdown field"
author: "CT"
date: 07.09.2016"
output:
  word_document: default
  
---
Purpose : 
This script reads the raw data from the field seed hardness breakdown (buried mesh bags)
It calculates the percentage of germinated seeds and accumulated percentage of seedlings
It find the linear regressions for the cultivars 

```{r loadLibraries}
library (lubridate)
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library(rgr)
```

Read file and 
```{r, loadFile}
setwd("C:\\GitHubRepos\\SubCloverPhD\\SubClover\\FieldBreakdown")
getwd()

#create file
df_seed <- read.table("FieldBreakdown.txt",header=TRUE)
head(df_seed)
summary(df_seed)

df_seed %>%
  filter(Plot==1)



```

Adjust formats and calculate the percentage of germinated seeds 
```{r}
# change format with basic R 
#df_seed$Date <- dmy(df_seed$Date)


df_seed <- df_seed %>%
  mutate(Plot = as.factor(Plot), Block = as.factor(Block)) %>%
  mutate(Germinated = as.numeric(Germinated)) %>%
  mutate(DAB = as.numeric(DAB))%>%
  mutate(PercCumGerm = as.numeric(PercCumGerm))
  

#summary(df_seed) # explore values
str(df_seed) # check formats
  


```



Then try to fit general  lm (not needed here as need to calculate for each cultivar )


```{r}
#CumulativePercentage of Soft Seeds

df_soft_plot <- a %>%
  #dplyr::select(-Date) %>%
  group_by(SowTreat,Cultivar,Block, Plot)  # need to keep level in which cumulation occurs
 

summary(df_soft_plot)
str(df_soft_plot)

plots <- unique(df_soft_plot$Plot)
#block <- unique(df_soft_plot$Block)
all.data <- NULL

for(p in 1:length(plots)) {
  #for(d in 1:length(block)) {
  
  df_sub <- subset(df_soft_plot, (df_soft_plot$Plot==plots[p] )) 
                   #& Block == block[d]))
  
  x <- df_sub$DAB
  y <- 1-df_sub$PercSoftCum
  
  print(data.frame(x=x,y=y))
  
  
  fit <- NULL
  fit <- lm(y ~ x)
  
  intercept <- round(fit$coefficients[[1]],2)
  slope <- round(fit$coefficients[[2]],3)
  r2 <- round(summary(fit)$r.squared * 100,2)
  # summary(fit)$adj.r.squared
  block <- df_sub$Block[1]
  cv <- as.character(df_sub$Cultivar[1])
  #sow <- as.character(df_sub$SowTreat[1])
  #sd <- dmy(df_sub$SowingD[1])
  
  
  buf <- c(cv,block, plots[p], intercept, slope, r2, nrow(df_sub))
  print(buf)
  
    if (p==1 ) { 
    all.data <- data.frame(
    
    Cultivar = cv,
    Block = block, 
    Plot = plots[p],  
    Int = intercept, 
    Slope = slope, 
    R2 = r2,
    n = nrow(df_sub)
    ) } else {
    all.data <- rbind(all.data, buf) # FIXME: Logic is not working for df creation
  }

# Error:  
#   Warning message:
# In `[<-.factor`(`*tmp*`, ri, value = "2") :
#   invalid factor level, NA generated
  

  }
  


summary(all.data)

```

End of this script. Move to script 3. 
