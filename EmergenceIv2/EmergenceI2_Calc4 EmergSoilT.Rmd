---
title: "Emergence seedlings I2"
author: "CT"
date: "02.01.2016"
output: html_document
---

This script does this:

- get the dataframe with sowing dates and date to 50% Emergence  
- get the dataframe with soil temperature 
- merge the two dataframes to calculate the mean temperature during emergence
-graph y=Days to 50% emergence ; x= mean soil Temp
-graph y= 1/days to 50% emergence ; x= mean soil Temp


```{r loadLibraries, warning=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(agricolae)
library(knitr)
library(lubridate)
library(mosaic)
library(lattice)
```

First read the dataframe with the emergence and  accumulated SoiTT. 
Create a D dataframe and store.

```{r loadFile}
# Get dataframe 1 with the soil Temp 
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\EmergenceIv2")
getwd()

#create file
df_emerg4 <- read.table("df_emerg_perc_soilTT.txt",header=TRUE)
#head(df_emerg4)

df_emerg4$ReadingDate <- ymd(df_emerg4$ReadingDate )
df_emerg4$SowingDate <- ymd(df_emerg4$SowingDate )
df_emerg4$Block <- as.factor(df_emerg4$Block)
df_emerg4$Plot <- as.factor(df_emerg4$Plot)
# str(df_emerg4)
# head(df_emerg4)

D <- df_emerg4 %>%
dplyr::select(Cultivar,SowTreat, Plot, SowingDate)

summary(D)

df_emerg4 <- NULL

```
Second, read the dataframe with the calculated 50 percent emergence.


```{r}

# Get dataframe 2 with the date to 50 % Emerg
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\EmergenceIv2")
getwd()

#create file
df_emerg5 <- read.table("df_tt_50p_emerg.txt",header=TRUE)
head(df_emerg5)

#df_emerg5$ReadingDate <- ymd(df_emerg5$ReadingDate )
#df_emerg5$SowingDate <- ymd(df_emerg5$SowingDate )
df_emerg5$Block <- as.factor(df_emerg5$Block)
df_emerg5$Plot <- as.factor(df_emerg5$Plot)
str(df_emerg5)
head(df_emerg5)


```
Days to reach 50% from sowing date. Create a E dataframe and store.

```{r}

E <-df_emerg5 %>%
dplyr::select(Plot,DAS50E)

summary(E)

df_emerg5 <- NULL

```

Finally merge the two data frames D and E by Plot number.
Create a new dataframe df_M

```{r}

#Merge the two dataframes by plot


df_M <- merge(D,E,by ="Plot")
str(df_M)
head(df_M)


         
```

```{r}
#Then calculate the date to 50% Emergence sum the date or sowing + DAS50E
#Note df_Md has duplicated rows - fix it!! 

df_MD <- df_M %>%
  mutate(Date50E=SowingDate+DAS50E) %>%
  group_by(Plot, DAS50E) %>% 
  dplyr::filter(row_number() == 1)

str(df_MD)
#Here DAte50E is included no nee to change format 

# mutate(Date50E = dmy(Date50E)

E <- D <- df_M <- NULL
```

Check data

```{r}
summary(df_MD)
```

TRy to erase duplicated rows 

```{r}

# #Remove duplicated rows here 
# df_MD2 <-df_MD %>%
#    group_by(Plot, DAS50E) %>% 
#   dplyr :: filter(row_number() == 1)
#   done previous schunk
#   
# summary(df_MD2)


```


Bring the measured soil temperature file. This is needed to calculate the average temperature at emergence period.

```{r}

# Get dataframe 1 with the soil Temp 
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\EmergenceIv2")
getwd()

#create file
df_emerg6 <- read.table("SoilTemp.txt",header=TRUE)
head(df_emerg6)

df_emerg6$Date <- dmy(df_emerg6$Date )
# df_emerg4$SowingDate <- ymd(df_emerg4$SowingDate )
# df_emerg4$Block <- as.factor(df_emerg4$Block)
# df_emerg4$Plot <- as.factor(df_emerg4$Plot)
str(df_emerg6)
head(df_emerg6)



```

Calculate the  sum of soil temperature
```{r}
df_soilTemp <- df_emerg6 %>%
  mutate(soilTempAcc = cumsum(TempSoil10mm)) %>%
  dplyr::select(-TempSoil10mm)

#head(df_soilTemp)

summary(df_soilTemp)

df_emerg6 <- NULL

```

```{r}

df_soilTemp %>%
  ggplot(aes(x=Date,y=soilTempAcc)) +
  geom_point()

```

Then merge the dataframes (MD and soiTemp)


```{r}

#Merge the two dataframes by Date
df1 <- merge(df_MD,df_soilTemp, by.x="SowingDate",by.y="Date") %>%
  mutate(soilTempAcc_sow = soilTempAcc) %>%
  dplyr::select(-soilTempAcc)

str(df1)
```

Check if data is ok. 

```{r}
summary(df1)
```

The attribute a date for the days after emergence when 50% is reached. 
Then calculate the average soil temperature at emergence as 
soilTempAcc_em-soilTempAcc_sow)/DAS50E.
Create a column called meanTemp_Em

```{r}

# force formats of dates
df1$Date <- round(df1$Date50E,0)
df_soilTemp$Date <- round(df_soilTemp$Date,0)


  df_merge <- merge(df1, df_soilTemp, by="Date") %>%
  mutate(soilTempAcc_em = soilTempAcc) %>%
  dplyr::select(-soilTempAcc) %>%
  mutate(meanTemp_Em = (soilTempAcc_em-soilTempAcc_sow)/DAS50E)  

summary(df_merge)

write.table(df_merge, "df_MeanSoilTemp50Emerg.txt") 
```

Then graph the results excluding S1 (problematic experiment)
```{r}

df_merge %>%
  filter(SowTreat!= "S1")%>% 
  group_by(Cultivar,SowTreat) %>%
  summarise(meanTemp_Em=mean(meanTemp_Em),DAS50E = mean(DAS50E))%>%
  ggplot(aes(x=meanTemp_Em,y=DAS50E,colour=Cultivar)) +
  theme_bw()+
  geom_point()

```



END of this script.
Graphs with DAS50E with mean soil Temp continue in Script EmergenceI2_Calc5EmergSoilGraph


