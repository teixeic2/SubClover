---
title: "Spectra of S2All FTIR test"
author: "CT"
date: "17.09.2017"
output: html_document
#here files have already been baselined corrected in OPUS. Raw data is on folder Bionami Maatrix 25.04; worksheet Columns to R. In this script the analysis of wavenumber ranges and ANOVAS.
---


```{r setup, include=FALSE, loadlibraires}
#knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library(scales)
library(hyperSpec)

```


```{r readData}
setwd("C:\\GitHubRepos\\SubCloverPhD\\SubClover\\Spectra_S2_Anovas")
getwd()

info <- read.table ("S2All.txt",  header = TRUE)

summary (info)

```
```{r}
str(info)
```


Adjust formats 

```{r}

info_av <- info %>%
  mutate(Plot=factor(Plot), Block=factor(Block), wavelength=factor(wavelength)) %>%
    dplyr::select(-Seed) %>%
  group_by(Plot, Cultivar,Block,wavelength) %>%
  summarise_each(funs(mean)) %>%
  mutate(wavelength=as.numeric(as.character(wavelength))) 

summary(info_av)

write.table(info_av, "Absorb_Per_WL.txt")

```

Loop throup spectra


```{r}
# set limits
mn<-min(info_av$wavelength)
mx<-max(info_av$wavelength)
wv <- unique(info_av$wavelength)


##print(paste0("Loop from ",mn," to ", mx))

data.all <- data.frame()

x <- 0 # for t test

#select the inteval of the spectra to analyse 
for(i in seq(from=1, to=length(wv), by=1)) {
  
  #print(wv[i])
  #print(paste0("Wavelength ",wv[i]))
  
  df <- info_av %>%
  subset(wavelength == wv[i])
  
  my.anova <- aov(Absorbance ~ Cultivar + Block, data = df)
  
#  print(summary(my.anova))
  
  pVals <- summary(my.anova)[[1]][["Pr(>F)"]]
  
  
  # T test when P<0.05
  if(!is.nan(pVals[1]) & pVals[1] < 0.05) {
  
  x <- x + 1
  t_test <-  LSD.test(my.anova, c("Cultivar"), alpha= 0.05, p.adj="none")
  lsd <- t_test$statistics[4]
  
 # treats <- t(ttest$groups)[1,] # FIXME: in the case we need more info
 # mSep <- t(ttest$groups)[3,]

  } else {
    
   lsd <- NA
   
  }
  
  this.data = data.frame(WL = wv[i], PV = pVals[1], LSD = lsd)
  
  data.all <- rbind(data.all, this.data)
  
}

x

```

```{r}
summary(data.all)
```

```{r, warning=FALSE}
data.all %>%
  ggplot(aes(x=WL,y=PV)) +
  geom_rect(data=NULL,aes(xmin=650,xmax=4000,ymin=0,ymax=0.05),fill="lightpink", alpha = 0.01) +
  geom_line() +
  theme_bw()+
  geom_abline(slope=0, intercept=0.05, linetype=2)+
   scale_x_reverse(breaks = seq(650, 4000, by = 100))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab(expression(Wavenumber~"(cm"^"-1"*")"))+
  ylab(expression(P~value ~"(P)"))
```

## Write data frame 

- as table for subsequent analysis 

```{r}

#write table in file 
write.table(data.all, "WavePvalues.txt")
getwd()
```

Then continue analysis in script 2 

