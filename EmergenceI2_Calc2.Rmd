---
title: "Emergence seedlings I2"
author: "CT"
date: "Thursday, December 31, 2015"
output: html_document
---

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library(mosaic)
library(lattice)
```


```{r loadFile}
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover")
getwd()

#create file
df_emerg1 <- read.table("df_emerg_perc_TT.txt",header=TRUE)
df_emerg1$ReadingDate <- ymd(df_emerg1$ReadingDate )
df_emerg1$SowingDate <- ymd(df_emerg1$SowingDate )
df_emerg1$Block <- as.factor(df_emerg1$Block)
df_emerg1$Plot <- as.factor(df_emerg1$Plot)
str(df_emerg1)
head(df_emerg1)
summary(df_emerg1)
```

Calculate 50 PercentEmergence  

```{r}


df_50_Perc <- df_emerg1 %>%
  mutate(DAS = as.numeric(ReadingDate-SowingDate)) %>%
  group_by(Cultivar,SowTreat, PercEmerg, 
  ReadingDate) %>%
  summarise(av_Perc = mean(PercEmerg), 
            av_TT = mean(TT_FromSow),
            av_DAS = mean(DAS)
            )

str(df_50_Perc)
summary(df_50_Perc)
head(df_50_Perc)

write.table(df_50_Perc, "df_50_PercEmerg.txt")

#  loop to calculate tt_50p_flow for each var x sd x cv
cv <- unique(df_50_Perc$Cultivar)
#var <- unique(df_50_Perc$PercEmerg)
sow <- unique(df_50_Perc$SowTreat)
sowd <- unique(df_50_Perc$SowingDate)

# create empty df
df_tt_50p_emerg <- data.frame(SowingD = NULL,
                             Cultivar = NULL, 
                             SowTreat = NULL,
                             PercEmerg = NULL, 
                             TT50Em = NULL)

#loop trough each combination of factor levels

for(i in 1:length(cv)) {
#  for(j in 1:length(var)){
    for(k in 1:length(sow)){
      
      # clean value holders
      DAS_50p_emerg <- 0
      tt_50p_emerg <- 0
      
      #FIX ME Partially set 
    
     # print(paste0(cv[i]," ",var[j]," ", sow[k]))
      # filter for each combination

  df_sub <- df_50_Perc %>%
    subset(Cultivar == as.character(cv[i]) &
#    Variable == as.character(var[j]) &
    SowTreat == as.character(sow[k])) %>%
    arrange(PercEmerg)
  
  df_sub
  
  # create percentage with maximum value recorded 
  # to avoid crossing the 50% line twice
  
  df_sub$av_Perc_max <- 0 # create new col
  
  for(z in 1:nrow(df_sub)) {
    
    df_sub$av_Perc_max[z] <- max(df_sub$av_Perc[z],
                                 df_sub$av_Perc_max[z-1])
    
  }
  
  df_sub
  head(df_sub)
  tail(df_sub)

  # Interpolate 
  y_ref <- 50 # y value where we want to find x by interpolation
  
  # interpolate
  #find DAS at 50 Pecent Emergence 

  tryCatch(  
  DAS_50p_emerg <- approx(df_sub$av_Perc_max, 
  df_sub$av_DAS , xout = y_ref, rule = 1)$y,
  error = function(e) 
  {
  DAS_50p_emerg <- NA
  }
)
  #find TT at 50 Pecent Emergence
  tryCatch(  
  tt_50p_flow <- approx(df_sub$av_Perc_max, 
  df_sub$av_TT , xout = y_ref, rule = 1)$y,
  error = function(e) 
  {
  tt_50p_emerg <- NA
  }
)

  df_temp <- NULL
  df_temp <- data.frame(Cultivar = df_sub$Cultivar[1],
                             PercEmerg = df_sub$PercEmerg[1], 
                             SowTreat = df_sub$SowTreat[1],
                          #   SowingD = df_sub$SowingDate[1], 
                             DAS50F = DAS_50p_emerg,
                             TT50F = tt_50p_emerg)
                        
  
  df_tt_50p_emerg <- rbind(df_tt_50p_emerg,df_temp)
      
    } 
  }
}


summary(df_tt_50p_emerg)

write.table(df_tt_50p_emerg,"df_tt_50p_emerg.txt")

summary(df_tt_50p_emerg)

```

not yet ready 

```{r GraphResults}

df_tt_50p_flow %>%
  filter( SowTreat != "S6" & SowTreat != "S7")%>%
  ggplot(aes(x=SowingD,y=DAS50F,colour=Cultivar))+
  geom_point()+
  facet_grid(Variable~.)+
  geom_line()

df_tt_50p_flow %>%
    filter( SowTreat != "S6" & SowTreat != "S7")%>%
  ggplot(aes(x=SowingD,y=TT50F,colour=Cultivar))+
  geom_point()+
  facet_grid(Variable~.)+
  geom_line()

summary(df_tt_50p_flow)


```





