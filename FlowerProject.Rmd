---
title: "Flowering 6CV"
author: "CT"
date: "Thursday, December 31, 2015"
output: html_document
---

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)

```



```{r loadFile}
setwd("C:\\Users\\Ed\\Documents\\Subclovergit")
getwd()

#create file
df_flower <- read.table("F_Flower_SB_PhenologyData.txt",header=TRUE)
colnames(df_flower)[1] <- "Date" # fix bug of extra characters in name
# convert to date format
df_flower <- df_flower %>%
mutate(Date=dmy(Date),SowingD=dmy(SowingD))
str(df_flower)
head(df_flower)
```

Analysis of sowing date and cultivars for Bud considering Date 

```{r GraphBoxPlotBud}

head(df_flower)
 df_flower %>%
  group_by(DAS,Date, Cultivar,SowTreat,Variable)%>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,Date,SowTreat)%>%
  filter(Variable == "Bud") %>%
  ggplot(aes(x=Date, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Cultivar, scales = "free")+
  geom_abline(intercept = 50, slope = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


Analysis of Sowing dates and variables (from bud to bur4) considering DAS 

```{r GraphSowingDateAndVariable}

df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  group_by(DAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,DAS,SowTreat) %>%
  filter(Cultivar == "Leura" | Cultivar =="Monti") %>%
  ggplot(aes(x=DAS, y=Percent)) + 
  #geom_bar(shape=1, stat="identity")
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Read Thermal Sum data.

```{r ReadThermalSumData}
# read raw data
df_TTSum <- read.table("ThermalSum.txt",header=TRUE)

# convert to date format
df_TTSum <- df_TTSum %>%
 mutate(Date=ymd(Date))

# remove extra columns
df_TTSum <- df_TTSum %>%
  dplyr::select(-MeanAirT)

# check
head(df_TTSum)
summary(df_TTSum  )
names(df_TTSum)
str(df_TTSum$Date)
tail(df_TTSum)

```

Merge dfs TTSum at Measurement and Sowing Date into Flowering df

```{r MergeTTSumDate}

# Add Tt at measurement date
df_flower <- merge(df_flower,df_TTSum,by="Date")

# change name TT to TT at measurement
df_flower <- df_flower %>%
rename(TT_meas = TT)
head(df_flower)

# Add Tt at sowing date
df_TTSum_mod <- df_TTSum %>%
  mutate (SowingD = Date) %>%
  dplyr::select (-Date)

df_flower <- merge(df_flower,df_TTSum_mod, by = "SowingD")

# change name TT to TT at measurement
df_flower <- df_flower %>%
rename(TT_sow = TT)
head(df_flower)

#check
head(df_flower)
summary(df_flower )

```

Include Photoperiod at sowing date in main df 

```{r mergePhotoperiod}

#create file
df_Photo <- read.table("Photoperiod.txt",header=TRUE)

# convert to date format
df_Photo <- df_Photo %>%
mutate(Date=dmy(Date))
head(df_Photo)

# rename date column for merge
df_Photo <- df_Photo %>%
rename(SowingD = Date)
head(df_Photo)

#Add Pp to df_flower (merge by SowinD)
df_flower <- merge(df_flower,df_Photo,by="SowingD")
head(df_flower)
summary(df_flower)

# change name PP to PP at sowing date
df_flower <- df_flower %>%
rename(Pp_sow = Pp)
head(df_flower)

```

calculate TT after sowing 

```{r Calc_TT_afterSow}

df_flower$TTAS <- df_flower$TT_meas-df_flower$TT_sow
head(df_flower)

# graph
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  group_by(TTAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,TTAS,SowTreat,SowingD) %>%
  filter(Variable == "Bud") %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Cultivar, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 60, hjust = 1))


#by variable 
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  group_by(TTAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,TTAS,SowTreat) %>%
  filter(Cultivar == "Monti" | Cultivar == "Leura" ) %>%
  #filter(Variable == "Bud") %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 60, hjust = 1))

```

Merge phenological stages into "bud, flower and burr"

```{r joinEarlyOpenFlower}

# create df with flowering stages only (merged)
df_flower_simple <- df_flower %>%
filter(Variable == "Early" | 
         Variable == "Open" | 
         Variable == "Petal") %>%
group_by(Date, Plot) %>%
  mutate(Variable = "Flowering", 
         S1=max(S1), 
         S2=max(S2),
         S3=max(S3), 
         S4=max(S4),
         S5=max(S5),
         Percent=((S1+S2+S3+S4+S5)/5)*100)

# merge both dfs
df_flower_simple <- rbind(df_flower, df_flower_simple)

# check
df_flower_simple %>%
  filter(Variable=="Flowering")  %>%
  head()


```

Do the same joining for Burr

```{r joinBurrStages}

# create df with bur only (merged bur1,2,3 and 4)
df_bur_simple <- df_flower %>%
filter(Variable == "Bur1" | 
         Variable == "Bur2" | 
         Variable == "Bur3"| 
         Variable == "Bur4" ) %>%
group_by(Date, Plot) %>%
  mutate(Variable = "Bur", 
         S1=max(S1), 
         S2=max(S2),
         S3=max(S3), 
         S4=max(S4),
         S5=max(S5),
         Percent=((S1+S2+S3+S4+S5)/5)*100)

# merge both dfs
df_bur_simple <- rbind(df_flower,df_flower_simple, df_bur_simple)

# graph it
df_bur_simple %>%
  filter(Variable == "Bud" |
           Variable =="Flowering"| 
           Variable =="Bur")  %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Flowering",
                             "Bur"))) %>%
  group_by(TTAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,TTAS,SowTreat) %>%
  #filter(Cultivar == "Monti" | Cultivar == "Leura" ) %>%
  #filter(Variable == "Bud") %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  geom_point(aes(shape=Cultivar,colour=Cultivar))+
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 60, hjust = 1))

unique(df_bur_simple$Variable)
```

Find 50 Percent of each variable for cultivar and sowtreat.

```{r Calc50PercFlower}

df_flower50 <- df_flower %>%
  group_by(Cultivar,SowTreat,Variable, DateMeasure,SowingD) %>%
  summarise(avP= mean(Percent),avTT= mean(TTAS))

head(df_flower50)
write.table(df_flower50, "df_flower50.txt")

#  loop to calculate tt_50p_flow for each var x sd x cv
cv <- unique(df_flower50$Cultivar)
var <- unique(df_flower50$Variable)
sow <- unique(df_flower50$SowTreat)
sowd <- unique(df_flower50$SowingD)
df_tt_50p_flow <- data.frame(Cultivar = NULL, 
                             Variable = NULL, 
                             SowTreat = NULL, 
                             SowingD = NULL,
                             TT50F = NULL)

for(i in 1:length(cv)) {
  for(j in 1:length(var)){
    for(k in 1:length(sow)){
    
      print(paste0(cv[i],var[j], sow[k]))
      # filter for each combination

  df_sub <- df_flower50 %>%
    subset(Cultivar == as.character(cv[i]) &
    Variable == as.character (var[j]) &
    SowTreat == as.character (sow[k]))
  
  tryCatch(
  tt_50p_flow <- approx(df_sub$avP,df_sub$avTT , xout = 50)$y,
  error = function(e) 
  {
  tt_50p_flow <- NA
  }
)

  df_temp <- NULL
  df_temp <- data.frame(Cultivar = df_sub$Cultivar,
                             Variable = df_sub$Variable, 
                             SowTreat = df_sub$SowTreat,
                             SowingD = df_sub$SowingD,                   
                             TT50F = df_sub$tt_50p_flow)
                        
  
  df_tt_50p_flow <- rbind(df_tt_50p_flow,df_temp)
      
    } 
  }
}


summary(df_tt_50p_flow)



write.table(df_tt_50p_flow,"df_tt_50p_flow.txt")

head(df_tt_50p_flow)


```

Now take the dataframe with 50 to flower and combine with photoperiod 

```{r}

#merge two data frames by ID
df_photoTT <- merge(df_tt_50p_flow,df_Photo,by="SowingD")
head(df_photoTT)
summary(df_photoTT )



```





next step: join early_open and petal categories to create " flower" 

Graph TTAS and Photoperiod 

```{rGraphPhoto}

# graph it
df_bur_simple %>%
  filter(Variable == "Bud" |
           Variable =="Flowering"| 
           Variable =="Bur")  %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Flowering",
                             "Bur"))) %>%
  group_by(TT50F,Cultivar,SowTreat,Variable,Pp) %>%
  summarise_each(funs(mean)) %>%
  select(Variable,Percent, Cultivar,TT50F,SowTreat,Pp) %>%
  #filter(Cultivar == "Monti" | Cultivar == "Leura" ) %>%
  #filter(Variable == "Bud") %>%
  ggplot(aes(x=TT50F, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  geom_point(aes(shape=Cultivar,colour=Cultivar))+
  facet_grid(Pp~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 60, hjust = 1))

unique(df_bur_simple$Variable)


```





