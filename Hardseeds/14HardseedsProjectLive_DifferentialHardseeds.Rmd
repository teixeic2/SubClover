---
title: "Hardseeds Slopes 6CV"
author: "CT"
date: " 27 November, 2018"
output:
  word_document: default
  pdf_document: default
  html_document: default
---
Purpose: this script calculates the differential in hardseed  based on percent of hardseeds initially (Max hardseeds at day 14 or TTsum = 0) and at the final incubation day (98 days, TTsum = 1680) 

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library(markdown)

```

Get the dataframe 

```{r loadFile}
setwd("C:\\GitHubRepos\\SubCloverPhD\\SubClover\\Hardseeds")

#create file
df_seed <- read.table("dfHard_break.txt",header=TRUE)
head(df_seed)



```

Thermal sum 

```{r}
# get TT at each  day
#create file
df_Tt <- read.table("dfHard_breakTT.txt",header=TRUE) %>% dplyr::select(Days,TtSum) %>% unique()
head(df_Tt)


```

```{r}
plot(df_Tt)
```



Just change name of dataframe and select columns to work 
```{r}
#Select depth of interest start with above seeds 

df_temp <- df_seed %>%
 mutate(Days=Round) %>%
 dplyr::select(Plot, Cultivar, Block, SowingD, SowTreat, Days, Depth, HardAccum, Round) 

dfSubSet <- merge(df_temp, df_Tt, by="Days")

dfSubSet$LoopIndex <- as.factor(paste0(dfSubSet$Plot,"_",dfSubSet$Depth)) # prepare for loop below

summary(dfSubSet)
  
```


graph hardseed decay with thermal time - data exploration

```{r}
 
df_graf <-dfSubSet %>%
  group_by(Cultivar,SowingD, SowTreat, TtSum) %>%
  dplyr::select(HardAccum) %>%
  summarise_all(funs(mean,sd)) 


df_graf %>%
  filter(SowTreat=="S2")%>%
  filter(Cultivar=="Antas"| Cultivar=="Monti" )%>%
ggplot(aes(x=TtSum , y=mean, colour=Cultivar, shape=Cultivar)) +
  geom_point(size=3) +
  geom_line() +
 #facet_grid(Depth~SowTreat) +
  labs(x="TT",y=" Percentage of LiveHardseeds") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
                  geom_errorbar(aes(ymin=mean-sd/3.46,
                    ymax=mean+sd/3.46),width=1,
                      size=0.4)+
  theme_bw()+
  ylim(0,100)+
  xlim(0,1900)+
  ylab(expression(Percentage~of~Hardseeds~"(%)"))+
  #theme(text = element_text(size=12))+
  xlab(expression(Thermal~time ~"("^"o"*"Cd)"))+
  theme(axis.text.x=element_text(angle = 0, hjust = 0.5, size= 11))+
  theme(axis.title.x=element_text(angle = 0, hjust = 0.5, size= 16))+
  theme(axis.text.y=element_text(angle = 0, hjust = 0, size= 12))+
  theme(axis.title.y=element_text(angle = 90, hjust = 0.5, size= 16))

#ggsave("plot_Antas_Narrikup.png", width=12, height=6, dpi=400)
```

Select only intial and final days to calculate differential 


```{r}

str(dfSubSet)

df_Dif <-dfSubSet %>%
  filter(Round=="14"|Round=="98")%>%
  mutate (Round = as.character(Round))

#Spread Round to calculate the differencet the beggining and at the end of the incubation 

## Dif = HardAccum14 - HardAccum98 / days or TT  

df_Dif1<- df_Dif %>%
  select(LoopIndex,Round,HardAccum)%>%
  spread(Round, HardAccum)

#Change column names 
colnames(df_Dif1)<- c("LoopIndex", "HardPerc_Initial14", "HardPerc_End98") 

#Calculate the difference 
  df_Dif2<-df_Dif1 %>%
    mutate(Difference=HardPerc_Initial14-HardPerc_End98)

  str(df_Dif2)
  


```

Now bring the differential values to the main dataframe dfSubSet


```{r}

#Prepare data frame 1 with all column names-factors  :

#Days   Plot   Cultivar Block   SowingD    SowTreat   Depth  HardAccum 
df_A <-dfSubSet %>%
  filter(Round=="14")%>%
 dplyr:: select(Plot,Block,Cultivar:Depth, LoopIndex)
  
#bring dataframe with Differential values 
str(df_Dif2)

#merge dataframes by Loopindex 

df_Dif3 <- merge(df_A, df_Dif2, by= "LoopIndex")




```

Calculate diferential divided by TT sum 

```{r}

df_Dif3 <-df_Dif3 %>%
  mutate(DecreHard_TTunit= Difference/1680)

```


Check if means are making sense 


```{r}

MeanHardEnd <-df_Dif3 %>%
  group_by(Cultivar, SowTreat)%>%
  #select(End98)%>%
  dplyr::select(  HardPerc_End98) %>%
  summarise_all(funs(mean,sd))
  

```

###### Graphics ######


```{r, fig.height=5, fig.width=15}


df_graf2 <-df_Dif3
  

# define position of bar and errorbar
dodge_x <- position_dodge(width = 0.9)

df_graf2 %>%
  group_by(Cultivar, SowTreat, Depth)%>%
  #dplyr::select(  HardPerc_End98) %>%
  dplyr::select(  HardPerc_End98) %>%
  summarise_all(funs(mean,sd))%>%
  ungroup%>%
  mutate (SowTreat= factor(SowTreat, levels=c("S1", "S2", "S3", "S4", "S6", "S7"),labels=c("June", "July", "September", "November", "February", "March")))%>%
     #added ....here mutate cultivar labels for poster  
   mutate (Cultivar= factor(Cultivar, levels=c("Antas", "Denmark", "Leura", "Monti", "Narrikup", "Woogenellup"),labels=c("A", "D", "L", "M", "N","W")))%>%
  #filter(SowTreat=="S2")%>%
  #filter(Cultivar=="Antas"| Cultivar=="Monti" )%>%
  #filter(TtSum=="0"| TtSum=="1680" )%>%
#mutate (TtSum= factor(TtSum, levels=c("0", "1680"),labels=c("DAY 0 ", "DAY 84")))%>%
 ggplot(aes(x=Cultivar, y=mean, fill=Cultivar)) +
  geom_bar(stat="identity",position = dodge_x) +
  geom_errorbar(aes(ymin=mean-sd/3.46,
                    ymax=mean+sd/3.46),
                width=0.25, size=0.3,position=dodge_x)   +
  theme_bw(base_size = 16) +
    theme_bw()+
  facet_grid(Depth~SowTreat, scales="free") +
    scale_fill_brewer(palette="Blues")+
    labs(y= " Decrease in Hardseed  (%) ")+
theme(axis.text.y = element_text( size = 11))+
  #theme(axis.title.y = element_text(face="bold", size=14))+
theme(axis.text.x=element_text(angle = 0, hjust=0.95,vjust=0.2,size = 24)) +
  theme(text = element_text(size = 20))+


#remove grid lines 
     theme(
     panel.border = element_rect(colour = "black", size = 2), 
     panel.grid.major = element_blank(),
     panel.grid.minor = element_blank(),
     axis.line = element_line(colour = "black"))+
  
  #make sowing dates white  
   theme(strip.background = element_rect(colour = "black", fill = "white",size=2))+
   theme(text = element_text(size = 24))+
    
   scale_y_continuous(expand = c(0, 0), limits = c(0, 100))


        #scale_fill_manual("legend", values = c("Antas" = "#660066", "Denmark" = "lightgrey","Leura" = "darkgrey", "Monti" = "#FF9933","Narrikup" = "blue",  "Woogenellup" = "#033333"))+
   
    #margin y axis
   theme (axis.title.y = element_text( margin = margin(t=0,r=10,b=0,l=0)))
    
   
     
    #ylab(expression(Number~of~seeds/m^"2")) 

```


##### Perform Stats #######


```{r ANOVAMaxPlantPop}

str(df_Dif3)

#compare DAE_1T  among cultivars

df_ANOVA <- df_Dif3  %>%
  dplyr::select(Cultivar,Block,Plot, SowTreat, Depth,Difference,DecreHard_TTunit )

```

##Overall analysis consider sowing date and cultivar 

```{r}
##Overview   variable = Difference

file <- df_ANOVA
file$transf_no <- 1*(df_ANOVA$Difference)
head(file)

#-------------------------------------------------
# ANOVA 
file.subset <- file 

head(file.subset)
summary(file.subset)
my.anova <- aov(transf_no ~ Cultivar*Depth + SowTreat, 
                data = file.subset)

summary(my.anova)

```

#####  Inspect First LSD 

```{r}
#Means separation after ANOVA
#(LSD.test(my.anova, c("Cultivar"), alpha= 0.05, p.adj="none")) 

(LSD.test(my.anova, c("Cultivar", "SowTreat"), alpha= 0.05, p.adj="none")) 


```


```{r}
posthoc <- TukeyHSD(x=my.anova, 'Cultivar', conf.level=0.95)
#posthoc <- TukeyHSD(x=my.anova, 'Cultivar', conf.level=0.25)

posthoc

```

Then 
This is the mean separation using Tukey 

```{r}

fogo<-HSD.test(my.anova, 'Cultivar', group=TRUE)
fogo

```




