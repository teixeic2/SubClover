---
title: "Flowering 6CV"
author: "CT"
date: "31.12.2015"
output:
  word_document: default
  pdf_document: default
  html_document: default
---
Aim: to calculate the percent of plants in specific reproductive phases : Bud, Early, Open, Petal, Bur1 _Bur4.

ATTENTION : this script has to run as continuous as the final dataframe generated (df_flower) is saved for further analysis and other scripts 

```{r loadLibraries}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)

```
Read file and adjust formats 

```{r loadFile}

setwd("C:\\GitHubRepos\\SubCloverPhD\\SubClover\\FlowIv2")

getwd()

#create file
df_flower <- read.table("F_Flower_SB_PhenologyData.txt",header=TRUE)

colnames(df_flower)[1] <- "Cultivar" # fix bug of extra characters in name

# convert to date format
df_flower <- df_flower %>%
mutate(Date=dmy(Date),SowingD=dmy(SowingD), 
       Percent=(S1+S2+S3+S4+S5)/5*100)

str(df_flower)
head(df_flower)
tail(df_flower)
```

Check data 
```{r}
summary(df_flower)
```

Analysis of sowing date and cultivars for Bud considering Date 

```{r GraphBoxPlotBud, fig.height= 5, fig.width= 8}

 df_flower %>%
  group_by(DAS,Date,Cultivar,SowTreat,Variable)%>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent,Cultivar,Date,SowTreat)%>%
  filter(Variable == "Bud") %>%
  ggplot(aes(x=DAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Cultivar, scales = "free")+
  #facet_grid(Cultivar~., scales = "free")+
  geom_abline(intercept = 50, slope = 0) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

Here to estimate the days between bud to petal 
split into early , medium late cvs and make from bud to fertilization (petal) 


```{r}

df_1<-df_flower %>%
  group_by(DAS,Date,Cultivar,SowTreat, Variable)%>%
  dplyr::select(Cultivar:Variable, Percent)%>%
  filter(Variable == "Bud"| Variable =="Petal"   )%>%
summarise_all(funs(mean)) 
summary (df_1)

```

This data frame was created to visualise means and write in chapter 4 

```{r}

df_2<-df_flower %>%
  group_by(DAS,Date,Cultivar,SowTreat,Variable)%>%
  select(Variable,Percent,Cultivar,Date,SowTreat)%>%
  #filter(Variable == "Bur4" | SowTreat== "S1" )%>%
  filter(Variable == "Petal"| Variable =="Bur4"   )%>%
summarise_each(funs(mean)) 

summary (df_2)


```



Analysis of Sowing dates and variables (from bud to bur4) considering DAS ; graph it . 

```{r GraphSowingDateAndVariable,fig.height=4, fig.width=10}

df_flower %>%
  #filter(SowTreat != "S6" & SowTreat != "S7")%>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  group_by(DAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,DAS,SowTreat) %>%
  filter(Cultivar == "Denmark" | Cultivar =="Leura") %>%
  ggplot(aes(x=DAS, y=Percent)) + 
  #geom_bar(shape=1, stat="identity")
  geom_line(aes(colour=Cultivar, shape=Cultivar)) +
  theme_bw()+
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0) +
 theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Graph of different variables for contrasting cultivars . Writing up chapter 4.

```{r GraphSowingDateAndVariable,fig.height=4, fig.width=10}

df_flower %>%
  #filter(SowTreat != "S6" & SowTreat != "S7")%>%
  mutate(Variable = factor(Variable,levels = c("Bud","Early","Open",
          "Petal"))) %>%
  group_by(DAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,DAS,SowTreat) %>%
  filter(Cultivar == "Monti" | Cultivar =="Narrikup") %>%
  ggplot(aes(x=DAS, y=Percent)) + 
  #geom_bar(shape=1, stat="identity")
  geom_line(aes(colour=Cultivar, shape=Cultivar)) +
  theme_bw()+
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0) +
 theme(axis.text.x = element_text(angle = 90, hjust = 1))

summary (df_flower)

```

Then include the TT calculated !!! TT cum 




Read Thermal Sum data. Need to include  values before 30 06 : 

Country	LocationYear	Date	DOY	Tx	Tm	MeanTt	Pp
NZ	Iversen2_2015	24/06/2015	175	7.30	-1.80	2.75	10.03173957
NZ	Iversen2_2015	25/06/2015	176	6.90	-3.90	1.50	10.033705
NZ	Iversen2_2015	26/06/2015	177	12.80	-0.70	6.05	10.03668323
NZ	Iversen2_2015	27/06/2015	178	17.40	-1.30	8.05	10.04067231
NZ	Iversen2_2015	28/06/2015	179	10.30	-1.70	4.30	10.04566961
NZ	Iversen2_2015	29/06/2015	180	17.30	3.70	10.50	10.05167184
NZ	Iversen2_2015	30/06/2015	181	18.50	1.30	9.90	10.05867507
"

```{r ReadThermalSumData}
# read raw data

#Temperatures from 24 June to 29 June included from Broadfield Niwa in excel Datalogger folder  Thermal Sum is created  in the the Thermal time project_TTCalc (R script_file)

#The df_CumTTiv.txt comes from the TTCalc script in the main Gitsubclover folder! Need to produce the file and add to the FlowIv2 folder for calculations. 

#the file df_CumTTiv2.txt contains the thermal sum hourly from Iversen. 
 
df_TTSum <- read.table("df_CumTTiv2.txt",header=TRUE)

# remove extra columns
df_TTSum <- df_TTSum %>%
dplyr::select(Date,SumTTday) %>%
  mutate(Date = ymd(Date))
 
#check
head(df_TTSum)

```
Check data 
```{r}
summary(df_TTSum)
```

Merge dfs TTSum at Measurement and Sowing Date into Flowering df
```{r}

# Add Tt at measurement date
df_flower <- merge(df_flower,df_TTSum, by="Date")

summary(df_flower)

```

Change column names and select only columns of interest (tidy up)

```{r}


# change name SumTTday to TT at measurement used mutate 1 x cause rename was faulty 
df_flower <- df_flower %>%
mutate(TT_meas = 1*(SumTTday))
#check the data 
str(df_flower)

#select only columns of interest 
df_flower <- df_flower %>%
dplyr::select (-S1, -S2, -S3, -S4, -S5) 

#check data 
str(df_flower)
```
Need to modify the column name to be able to merge 
```{r}
# Add Tt at sowing date
df_TTSum_mod <- df_TTSum %>%
  mutate (SowingD = Date) %>%
  dplyr::select (-Date)
 

```
Merge data frames 
```{r}
df_flower <- merge(df_flower,df_TTSum_mod, by = "SowingD")

str(df_flower)

# change name TT to TT at measurement
df_flower <- df_flower %>%
mutate(TT_sow = 1*(SumTTday.y))
#check
str(df_flower)

```

Graphic

```{r MergeTTSumDate}

#aqi
# TT from Bud to Bur 3 

df_flower %>%
  #filter(SowTreat != "S6" & SowTreat != "S7")%>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Petal"))) %>%
  group_by(DAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,SowTreat) %>%
  filter(Cultivar == "Narrikup" | Cultivar =="Denmark") %>%
  ggplot(aes(x=DAS, y=Percent)) + 
  #geom_bar(shape=1, stat="identity")
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
  
theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

Include Photoperiod at sowing date in main df 

```{r mergePhotoperiod}

# #create file
df_Photo <- read.table("Photoperiod.txt",header=TRUE)

# convert to date format
df_Photo <- df_Photo %>%
mutate(Date=dmy(Date))

str(df_Photo)

# rename date column for merge
df_Photo <- df_Photo %>%
mutate(SowingD = Date)
head(df_Photo)

#Add Pp to df_flower (merge by SowinD)
df_flower <- merge(df_flower,df_Photo,by="SowingD")
head(df_flower)
summary(df_flower)


 # change name PP to PP at sowing date
df_flower <- df_flower %>%
mutate(Pp_sow = Pp)
str(df_flower)



```

calculate TT after sowing 

```{r Calc_TT_afterSow}

df_flower$TTAS <- df_flower$TT_meas-df_flower$TT_sow
head(df_flower)


summary(df_flower)



```
Tidy up dataframe and remove extra columns 
```{r}

df_flower <- df_flower %>%
mutate (Date= (Date.x))%>%
dplyr:: select(SowingD:Percent, Pp_sow, TTAS, Date, -Date.x)
  
str(df_flower)

```


```{r}
# save final DF
write.table(df_flower, "df_flower.txt")

```

Graphics 

```{r}
# graph
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  filter(Cultivar=="Narrikup")%>%
  group_by(TTAS,Cultivar,SowTreat,Variable,DAS) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,TTAS,SowTreat,SowingD,DAS) %>%
  filter(Variable == "Bud"| Variable == "Open" ) %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Variable)) +
  facet_grid(SowTreat~Cultivar, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
   theme_bw()+
theme(axis.text.x = element_text(angle = 60, hjust = 1))+
labs(y="Percent of Plants with Floral bud ")+
xlab(expression(Thermal~time~~"("^"o"*"Cd)"))
 
```

```{r}
# graph
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  filter(Cultivar=="Narrikup")%>%
  group_by(TTAS,Cultivar,SowTreat,Variable,DAS) %>%
  summarise_all(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,TTAS,SowTreat,SowingD,DAS) %>%
  filter(Variable == "Bud"| Variable == "Bur1" ) %>%
  filter(SowTreat=="S7")%>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  #geom_line(aes(colour=Variable)) +
  geom_smooth()+
  facet_grid(SowTreat~Cultivar, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
   theme_bw()+
theme(axis.text.x = element_text(angle = 60, hjust = 1))+
labs(y="Percent of Plants with Floral bud ")+
xlab(expression(Thermal~time~~"("^"o"*"Cd)"))
```




Here analyse per stages means to write in chapter 4. 

```{r}

df_3<-df_flower %>%
  filter(Variable == "Bud"| Cultivar =="Narrikup")%>%
  group_by(TTAS,Date,Cultivar,SowTreat,Variable)%>%
  select(Variable,Percent,Cultivar,Date,SowTreat)%>%
  
summarise_all(funs(mean)) 

summary (df_3)


```



```{r}

#by variable 
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  group_by(TTAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,TTAS,SowTreat) %>%
  filter(Cultivar == "Monti" | Cultivar == "Leura" ) %>%
  #filter(Variable == "Bud") %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
  theme_bw()+
theme(axis.text.x = element_text(angle = 60, hjust = 1))





```




Derrick's graph

```{r GraphDerrick}

#by variable 
df_flower %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Early","Open",
          "Petal","Bur1","Bur2","Bur3","Bur4" ))) %>%
  
  group_by(TTAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  #select(Variable,Percent, Cultivar,TTAS,SowTreat) %>%
  filter(Cultivar == "Narrikup" | Cultivar == "Denmark" ) %>%
  filter(Variable == "Bud") %>%
  ggplot(aes(x=TTAS, y=Percent)) + 
  geom_line(aes(colour=Cultivar)) +
  facet_grid(SowTreat~Variable, scales = "free") +
  geom_abline(intercept = 50, slope = 0)+
theme(axis.text.x = element_text(angle = 60, hjust = 1))

```


End of this script.



