
---
title: "CreateMergedPhenologyStages"
author: "CT"
date: "17.01.2016"
output:
  html_document: default
  word_document: default
---

- This script continues from FlowerProject1 (df_flower) and creates three main flowering categories : Bud, Flowering and Bur 

```{r loadLibraries,echo=FALSE}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)

```


```{r loadFile, include=FALSE}
setwd("C:\\Users\\EdCarmen\\Documents\\CarmenProjects2016\\GitSubclover\\FlowIv2")
getwd()
```

Aim: Combine classes of phenology into simpler classes:
- Early + Open + Petal = Flowering
- Bur3 to Bur 4 = Burr

To facilitate analysis of thermal time

```{r}
#create file
df_flower <- read.table("df_flower.txt",header=TRUE)

summary(df_flower)

```
- Check data 

```{r}
head(df_flower)
```


# Create flowering class

- combine phenological stages Early + Open + Petal

```{r joinEarlyOpenFlower, warning=FALSE}

# create df with flowering stages only (merged)
df_flower_simple <- df_flower %>%
filter(Variable == "Early" | 
         Variable == "Open" | 
         Variable == "Petal") %>%
group_by(Date, Plot) %>%
mutate(Variable = "Flowering", 
       Variable=as.factor(Variable),
         S1=max(S1), # Maximum of 0 (absence) or 1 (presence) of that class
         S2=max(S2),
         S3=max(S3), 
         S4=max(S4),
         S5=max(S5),
         SimpleCat_Perc=((S1+S2+S3+S4+S5)/5)*100) %>% # percentage of sub-samples with the combined class
  mutate(SimpleCat_Perc=as.numeric(SimpleCat_Perc)) %>%
  dplyr::select(-(S1:Percent)) %>%
  ungroup()

summary(df_flower_simple)


```

# Create Burr class

- combine phenological stages Bur3 and Bur4

```{r joinBurrStages, warning=FALSE}

# create df with bur only (merged bur3 and 4 to create a phenophase called maturation did that cause the cahpter splits in bud to fertilization and then fertilization to seed mature)
df_bur_simple <- df_flower %>%
filter(Variable == "Bur3" | 
       Variable == "Bur4"  ) %>%
group_by(Date, Plot) %>%
  mutate(Variable = "Bur", 
       Variable=as.factor(Variable),
         S1=max(S1), # Maximum of 0 (absence) or 1 (presence) of that class
         S2=max(S2),
         S3=max(S3), 
         S4=max(S4),
         S5=max(S5),
         SimpleCat_Perc=((S1+S2+S3+S4+S5)/5)*100) %>% # percentage of sub-samples with the combined class
  mutate(SimpleCat_Perc=as.numeric(SimpleCat_Perc)) %>%
  dplyr::select(-(S1:Percent)) %>%
  ungroup()

summary(df_bur_simple)


```

- Data visualisation : graph class Bud
```{r}
# df with bud only
df_bud_simple <- df_flower %>%
  filter(Variable == "Bud") %>%
  group_by(Date, Plot) %>%
  mutate(Variable = "Bud", 
       Variable=as.factor(Variable),
         S1=max(S1), # Maximum of 0 (absence) or 1 (presence) of that class
         S2=max(S2),
         S3=max(S3), 
         S4=max(S4),
         S5=max(S5),
         SimpleCat_Perc=((S1+S2+S3+S4+S5)/5)*100) %>% # percentage of sub-samples with the combined class
  mutate(SimpleCat_Perc=as.numeric(SimpleCat_Perc)) %>%
  dplyr::select(-(S1:Percent)) %>%
  ungroup()

summary(df_bud_simple)


```

#Bind simple categories in the same df

```{r}
# bind both dfs
df_bud_flow_bur_simple <- 
  rbind(df_bud_simple, df_flower_simple, df_bur_simple)

#check
summary(df_bud_flow_bur_simple)

# save the dataframe 
write.table(df_bud_flow_bur_simple, "df_bud_flow_bur_simple.txt")
```

#Graph of simple categories

- - Data visualisation : graph classes and Average by treatment 

```{r graph,fig.height=10,fig.width= 10, warning=FALSE}
# graph it
df_bud_flow_bur_simple %>%
  filter(Variable == "Bud" |
           Variable =="Flowering"| 
           Variable =="Bur")  %>%
  mutate(Variable = 
  factor(Variable,levels = c("Bud","Flowering",
                             "Bur"))) %>%
  group_by(DAS,Cultivar,SowTreat,Variable) %>%
  summarise_each(funs(mean)) %>%
  filter(Variable == "Bud")%>%
  ggplot(aes(x=TTAS, y=SimpleCat_Perc)) + 
  geom_line(aes(colour=Cultivar)) +
  geom_point(aes(shape=Cultivar,colour=Cultivar))+
  #facet_grid(Cultivar~SowTreat, scales = "free") +
  facet_grid(Cultivar~SowTreat, scales = "free") +
  geom_abline(intercept = 50, slope = 0) +
  ylab("Percent of plants with floral Bud (%)") +
   xlab(expression(Thermal~time~~"("^"o"*"Cd)"))+
  #xlab("Thermal-time from sowing (oCd)")+
  theme_bw()+
theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

- End of this script. Continues in FlowerProject3 using the generated dataframe (df_bud_flow_bur_simple) to calculate the 50% time for flowering 
