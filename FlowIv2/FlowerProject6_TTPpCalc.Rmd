---
title: "similar to ReAnalysis Table"
author: "CT"
date: "24.04.2017"
output:
  word_document: default
  html_document: default
note: include Pp analysis using selected datasets from Reanalysis scripts but use Iversen 2 collected data  
---

```{r loadLibraries, echo=FALSE, include=FALSE}
library(tidyr)
library (dplyr)
library (ggplot2)
library(agricolae)
library(knitr)
library (lubridate)
library (segmented)
library(hydroGOF)

```
 
AIM:
- Estimate TT to 50% flowering in relation to Pp
- Find "when"" Pp has to be considered (i.e. Pp @ Tt between sowing till flowering)
- Do this by looking at figuest R2 fot Tt50 x Pp

```{r   loadFile}
setwd("C:\\GitHubRepos\\SubCloverPhD\\SubClover\\FlowIv2")

getwd()


```

```{r}
#get dataframe created similar to ReAnalysis4 which is Rea6 - use Iversen DAS50Flwoering data
df_tt_flow <- read.table("df_tt_50p_flow.txt",header=TRUE) 

# force date format
df_tt_flow$SowingD <- ymd(df_tt_flow$SowingD)
str(df_tt_flow)


```

```{r}
summary(df_tt_flow)
```

Bring weather dataset which is in df_CumTTIv.txt

```{r}

df_weather <- read.table("df_CumTTIv.txt",header=TRUE) %>%
  mutate(Date=ymd(Date)) %>%
  dplyr::select(-LocationYear,-Country) %>%
  dplyr::select(Date, SumTTday,Pp) # FIXME: this is also run Tt - change name to SumTTday_run?

  summary(df_weather)

```

Merge and calculate the two datasets 

- SumTT is value at sowing from 24 Jun 2015 
- TT50F_run (at flowering time) sets a limit for juvenile period - why? 

```{r}
# get TTsum at sowing
# estimates Tt with running TT sum from weather file
df_Iv <- merge(df_tt_flow, df_weather,
               by.x=c("SowingD"), 
               by.y=c("Date")) %>%
  ungroup()%>%
 # na.omit() %>%
  mutate(Pp_sow = Pp) %>%
  mutate(TtAtSowing_run = SumTTday) %>%
  dplyr::select(-SumTTday, -Pp) %>%
  mutate(TT50F_run = TT50F + TtAtSowing_run) %>% # Tt running at flowering
  mutate(cv_block_index = as.factor(paste0(Cultivar,"_",Block)))  %>%
  mutate(SowingD=ymd(SowingD))
 
str(df_Iv)

```


```{r}
summary(df_Iv)
```

# Plot Tt50 vs Pp at sowing

```{r, fig.width=12}

df_Iv %>%
  na.omit() %>%
  dplyr::select(Cultivar, SowTreat, Variable, TT50F, Pp_sow) %>%
  group_by(Cultivar, SowTreat, Variable) %>%
  summarise_all(funs(mean,sd)) %>%
  ggplot(aes(x=Pp_sow_mean,y=TT50F_mean, colour=Cultivar)) +
  geom_point()+
  geom_line()+
  facet_grid(Variable~.)

#FIME: Why 0 for Leura & xxxx? Should be NA? when no flowerng

```



```{r}

str(df_Iv)
```


```{r, fig.height=10, fig.width= 12}


 
dfGraph1 <- df_Iv%>% 
  dplyr::select(SowingD:SowTreat,Block, TT50F, Pp_sow)%>%
  filter(TT50F!=0)%>%
  filter (Variable=="Flowering")%>%
  
  group_by(Cultivar,SowingD,SowTreat)%>%
  #select variables to average 
  select(Cultivar,SowingD,SowTreat, TT50F, Pp_sow)%>%
  summarise_all(funs(mean))


#Remember that S5 A,D,W = no flowering ...how to deal here ? 
dfGraph1 %>%
  #filter(Variable==Flowering) %>%
  ggplot(aes(x=Pp_sow,y=TT50F,colour=factor(Cultivar))) +
  geom_point(aes(shape= SowTreat), size=4)+
  scale_shape_manual(values = c(0,1,2,3,4,5,6,7,8))+
  geom_point() + geom_line() + facet_grid(Cultivar~.)+
    ylim(0,3000)

```

```{r, fig.height=5, fig.width=15}


dfGraph1 %>%
   #filter(Cultivar=="Monti"| Cultivar=="Antas")%>%
  #filter (SowTreat== "S3"| SowTreat== "S4"|SowTreat== "S5"|SowTreat== "S6")%>%
  ggplot(aes(x=Pp_sow,y=TT50F,colour=factor(Cultivar)))   +
  #  geom_point(aes(shape= SowTreat), size=4)+
  geom_text(aes(label=SowTreat),hjust=0, vjust=0) +
  scale_shape_manual(values = c(0,1,2,3,4,5,6,7,8))+
  #geom_point(alpha=0.8) +
  #geom_smooth(colour="red")+
  #stat_smooth(level = 0.9, size = 1, colour="white") + 
  theme_bw() +
  xlab(expression(Mean~Thermal~time~Flowering~"("^"o"*"Cd)")) + 
  xlab(" Photoperiod at Sowing  ") +
  facet_grid(.~Cultivar, scales="free")+
  theme(text = element_text(size=11))+
 scale_x_continuous(limits = c(9,18))+
  scale_y_continuous(limits = c(0,2800))


```

Now assemble the Pp targets !!! 




##These chunks below need revision !!! why TT 50 run is added ? 


## calc

Find running sumTT for each sowing date at sowing

- only to have a small df for function below

- Obs: lebel tt as "_run" when using running sum of Tt across all sow dates

```{r}
sumTTatSow <- df_Iv %>%
  dplyr::select(SowTreat, TtAtSowing_run) %>%
  unique() %>%
  as.data.frame()

head(sumTTatSow)

```

Create function for retrieving photoperiod as a function of TT after sowing and Sowing date  treatment

- finds running TT at sowiong
- adds target to that and finds pp at that TT momrent
- tt_target is oCd after sowing when Pp is retrieved
- sowT is the sowing treatment (S1...)

```{r}

Pp_finder_func <- function(sowT, tt_target){
  
  #isolate the experiment and cultivar 
   sTT <- sumTTatSow %>% dplyr::filter(SowTreat == sowT) %>% dplyr::select(TtAtSowing_run)
   
   # sum target to sumTT at time of sowing for this spesific sd
   tt_target_adj <- tt_target + sTT 
   
  # lookup for Pp at new tt sum in weather file
  tryCatch(  
  Pp_target <- approx(df_weather$SumTTday, 
  df_weather$Pp, xout = tt_target_adj, rule = 1)$y,
  error = function(e) 
  {
  Pp_target <- NA
  }
)
 
  return(Pp_target)
  
}

```

## Test function

```{r}
st <- "S7"

#test
tt_target <- 500 
#TTsum estimated to reach 1st trifoliate 

#test if function is working : example : 
Pp_finder_func(st, tt_target)
```

# Find Pp at a given Tt sum after sowing

- Sums ftxed Tt to sowing Tt and see what Pp is there
- Plots this Pp against TT to flowering
- See if there is a stronger relationship beteen Pp and Tt

## Segment df by Cv and block 

```{r}

# FIXME: This logic is corrupted as graph for target ==0 is not as above

cv_block <- (unique(df_Iv$cv_block_index))

df_Iv_flow <- df_Iv %>% dplyr::filter(Variable=="Flowering") %>% na.omit()

# Loop 
df_pp_all <- data.frame()

for(p in 1:length(cv_block)) {
  
  CBI <- cv_block[p]
  
  # segment plot of interesst
  df_sub <- df_Iv_flow %>% 
    dplyr::filter(cv_block_index==cv_block[p])
  
  # loop through Tt chuncks after sowing
  # t is tt from sowing to the point where Pp is retrieved
    for(t in seq(from=0, to=min(df_sub$TT50F), by=100)){
    
 #   TT_target <- t # tt from sowing to the point where Pp is retrieved
  
    # Calculate Pp at this Tt sum after sowing
    df_sub_pp <- df_sub %>%
    rowwise() %>%
    mutate(TT_target = t)  %>%
    mutate(Pp_target=Pp_finder_func(SowTreat,TtAtSowing_run + TT_target))
    
    # Bind all results
    df_pp_all <- rbind(df_pp_all,df_sub_pp)
   
    }
}

summary(df_pp_all)

# FIXME: The extreme value of Tt target goes beyond current weather, need to expand it a bit

```



```{r, fig.width=12}
df_pp_all %>%
  ggplot(aes(x=TT_target,y=Pp_target)) +
  geom_point() + geom_line() + facet_grid(Cultivar~SowTreat)
```


```{r}

str(df_pp_all)

df_pp_all_mean <- df_pp_all %>%
    dplyr::select(Cultivar,Variable,SowTreat,TT50F,TT_target,Pp_target)%>%
    group_by(Cultivar,SowTreat, Variable)  %>%
    filter(Variable=="Flowering") %>%
    summarise_all(funs(mean))


summary(df_pp_all_mean)


df_pp_all_mean %>% filter(is.na(Pp_target))

for (i in )



dfGraph1 %>%
  ggplot(aes(x=Pp_sow,y=TT50F,colour=factor(Cultivar)))   +
  geom_text(aes(label=SowTreat),hjust=0, vjust=0) +
  scale_shape_manual(values = c(0,1,2,3,4,5,6,7,8))+
  theme_bw() +
  xlab(expression(Mean~Thermal~time~Flowering~"("^"o"*"Cd)")) + 
  xlab(" Photoperiod at Sowing  ") +
  facet_grid(.~Cultivar, scales="free")+
  theme(text = element_text(size=11))+
 scale_x_continuous(limits = c(9,18))+
  scale_y_continuous(limits = c(0,2800))

```





## Check data

```{r, fig.height= 10 , fig.width=15}

df_pp_all %>%
  filter(TT_target==500) %>%
  ggplot(aes(x=Pp_target,y=TT50F,colour=factor(Cultivar),shape=factor(SowTreat),size=3 )) +
  geom_point() + geom_line() +facet_grid(Cultivar~.)

```


## Graph again using mean values 


```{r, fig.height= 5 , fig.width=10}

str(df_pp_all)

dfTTPPtargets<-df_pp_all %>%
  dplyr::select(SowingD:SowTreat,Block, TT50F_run, TT_target, Pp_target)%>%
  group_by(Cultivar,SowingD,SowTreat, TT_target )%>%
  #select variables to average 
  select(TT50F_run, TT_target, Pp_target)%>%
  summarise_all(funs(mean))


#now graph one considering x = Pp-target set in  TT target of 500 for example  and Y TT50F run 


  df500 <- dfTTPPtargets %>%
  filter(TT_target==500) 
  
  
  df500 %>%
  #filter(TT_target==500) %>%
  ggplot(aes(x=Pp_target,y=TT50F_run,colour=factor(Cultivar))) +
  geom_point(aes(shape= SowTreat), size=4)+
  scale_shape_manual(values = c(0,1,2,3,4,5,6,7,8))+
  geom_point() + geom_line() +facet_grid(Cultivar~.)+
    ylim(0,5000)

```


## Can you use the multiple panels to plot TT against Pp targets ? 







